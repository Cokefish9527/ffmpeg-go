<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘å¤„ç†ç›‘æ§é¢æ¿</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .refresh-btn {
            background-color: #2196F3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .refresh-btn:hover {
            background-color: #1976D2;
        }
        .toggle-system-btn {
            background-color: #ff9800;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .toggle-system-btn:hover {
            background-color: #f57c00;
        }
        .system-info {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .system-info.hidden {
            display: none;
        }
        .system-stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .system-stat-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .system-stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2196F3;
        }
        .system-stat-label {
            color: #666;
            margin-top: 5px;
            position: relative;
        }
        
        .info-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background-color: #ccc;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            text-align: center;
            line-height: 16px;
            cursor: pointer;
            margin-left: 5px;
            user-select: none;
        }
        
        .info-tooltip {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px;
            border-radius: 4px;
            width: 200px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .info-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        
        .info-tooltip.show {
            display: block;
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2196F3;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .tasks-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .search-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .search-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .status-pending {
            color: #ff9800;
            font-weight: bold;
        }
        .status-processing {
            color: #2196F3;
            font-weight: bold;
        }
        .status-completed {
            color: #4caf50;
            font-weight: bold;
        }
        .status-failed {
            color: #f44336;
            font-weight: bold;
        }
        .button-group {
            display: flex;
            gap: 5px;
            flex-wrap: nowrap;
        }
        
        .button-group .btn {
            flex: 1;
            min-width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 2px;
        }
        .btn-retry {
            background-color: #4caf50;
            color: white;
        }
        .btn-discard {
            background-color: #f44336;
            color: white;
        }
        .btn-view {
            background-color: #9c27b0;
            color: white;
        }
        .clear {
            clear: both;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 1000px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .modal-title {
            margin: 0;
            font-size: 1.5em;
        }
        .info-icon {
            margin-left: 8px;
            cursor: pointer;
            color: #666;
            transition: all 0.2s ease;
        }
        
        .info-icon:hover {
            background-color: #999;
            transform: scale(1.1);
        }
        
        .icon-view::before {
            content: "ğŸ‘";
        }
        
        .icon-retry::before {
            content: "ğŸ”„";
        }
        
        .icon-discard::before {
            content: "ğŸ—‘";
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>è§†é¢‘å¤„ç†ç›‘æ§é¢æ¿</h1>
        
        <div class="controls">
            <button class="refresh-btn" onclick="loadAllData()">åˆ·æ–°æ•°æ®</button>
            <button class="toggle-system-btn" onclick="toggleSystemInfo()">éšè—ç³»ç»Ÿä¿¡æ¯</button>
        </div>
        
        <div id="systemInfo" class="system-info">
            <h2>ç³»ç»Ÿç›‘æ§</h2>
            <div class="system-stats-container">
                <div class="system-stat-card">
                    <div class="system-stat-value" id="cpuUsage">0%</div>
                    <div class="system-stat-label">CPUä½¿ç”¨ç‡</div>
                </div>
                <div class="system-stat-card">
                    <div class="system-stat-value" id="memoryUsage">0 MB</div>
                    <div class="system-stat-label">å†…å­˜ä½¿ç”¨</div>
                </div>
                <div class="system-stat-card">
                    <div class="system-stat-value" id="goroutines">0</div>
                    <div class="system-stat-label">
                        Goroutines
                        <span class="info-icon" data-tooltip="goroutines-info">â„¹</span>
                        <div id="goroutines-info" class="info-tooltip">
                            Goroutinesæ˜¯Goè¯­è¨€çš„è½»é‡çº§çº¿ç¨‹ï¼Œç”¨äºå¤„ç†å¹¶å‘ä»»åŠ¡ã€‚Goroutinesæ•°é‡åæ˜ äº†å½“å‰ç¨‹åºçš„å¹¶å‘æ´»åŠ¨æƒ…å†µã€‚
                        </div>
                    </div>
                </div>
                <div class="system-stat-card">
                    <div class="system-stat-value" id="workersActive">0/0</div>
                    <div class="system-stat-label">
                        æ´»è·ƒWorker
                        <span class="info-icon" data-tooltip="workers-info">â„¹</span>
                        <div id="workers-info" class="info-tooltip">
                            æ´»è·ƒWorkerè¡¨ç¤ºå½“å‰æ­£åœ¨å¤„ç†ä»»åŠ¡çš„Workeræ•°é‡ã€‚æ ¼å¼ä¸º"æ´»è·ƒæ•°/æ€»æ•°"ã€‚<br>
                            Workeræ˜¯å®é™…æ‰§è¡Œè§†é¢‘å¤„ç†ä»»åŠ¡çš„å·¥ä½œå•å…ƒã€‚
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value" id="totalTasks">0</div>
                <div class="stat-label">æ€»ä»»åŠ¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pendingTasks">0</div>
                <div class="stat-label">å¾…å¤„ç†</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="processingTasks">0</div>
                <div class="stat-label">å¤„ç†ä¸­</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completedTasks">0</div>
                <div class="stat-label">å·²å®Œæˆ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="failedTasks">0</div>
                <div class="stat-label">å¤±è´¥</div>
            </div>
        </div>
        
        <div class="tasks-container">
            <h2>ä»»åŠ¡åˆ—è¡¨</h2>
            <div class="search-container">
                <input type="text" id="searchKeyword" class="search-input" placeholder="è¾“å…¥ä»»åŠ¡IDæˆ–å…³é”®å­—">
                <select id="searchStatus" class="search-select">
                    <option value="">æ‰€æœ‰çŠ¶æ€</option>
                    <option value="pending">å¾…å¤„ç†</option>
                    <option value="processing">å¤„ç†ä¸­</option>
                    <option value="completed">å·²å®Œæˆ</option>
                    <option value="failed">å¤±è´¥</option>
                </select>
                <button class="search-btn" onclick="searchTasks()">æœç´¢</button>
                <button class="search-btn" onclick="loadTasks()">é‡ç½®</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ä»»åŠ¡ID</th>
                        <th>çŠ¶æ€</th>
                        <th>ä¼˜å…ˆçº§</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ‰§è¡Œæ¬¡æ•°</th>
                        <th>æœ€åæ‰§è¡Œ</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="taskList">
                    <!-- ä»»åŠ¡åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                </tbody>
            </table>
        </div>
        
        <div class="tasks-container">
            <h2>å¤±è´¥ä»»åŠ¡åˆ—è¡¨</h2>
            <table>
                <thead>
                    <tr>
                        <th>ä»»åŠ¡ID</th>
                        <th>ä¼˜å…ˆçº§</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ‰§è¡Œæ¬¡æ•°</th>
                        <th>æœ€åæ‰§è¡Œ</th>
                        <th>é”™è¯¯ä¿¡æ¯</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="failedTaskList">
                    <!-- å¤±è´¥ä»»åŠ¡åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- ä»»åŠ¡æ‰§è¡Œå†å²æ¨¡æ€æ¡† -->
    <div id="executionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ä»»åŠ¡æ‰§è¡Œå†å²</h3>
                <span class="close" onclick="closeExecutionModal()">&times;</span>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>æ‰§è¡Œåºå·</th>
                        <th>çŠ¶æ€</th>
                        <th>å¼€å§‹æ—¶é—´</th>
                        <th>ç»“æŸæ—¶é—´</th>
                        <th>é”™è¯¯ä¿¡æ¯</th>
                    </tr>
                </thead>
                <tbody id="executionList">
                    <!-- æ‰§è¡Œå†å²å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // APIåŸºç¡€URL
        const API_BASE = '/api/v1';
        
        // ç³»ç»Ÿä¿¡æ¯æ˜¾ç¤ºçŠ¶æ€
        let systemInfoVisible = true;
        
        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        window.onload = function() {
            loadAllData();
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡æ•°æ®
            setInterval(loadAllData, 30000);
            
            // åˆå§‹åŒ–ä¿¡æ¯æç¤ºåŠŸèƒ½
            initTooltips();
        };
        
        // åˆå§‹åŒ–ä¿¡æ¯æç¤ºåŠŸèƒ½
        function initTooltips() {
            const infoIcons = document.querySelectorAll('.info-icon');
            
            infoIcons.forEach(icon => {
                // é¼ æ ‡æ‚¬åœäº‹ä»¶
                icon.addEventListener('mouseenter', function() {
                    const tooltipId = this.getAttribute('data-tooltip');
                    const tooltip = document.getElementById(tooltipId);
                    if (tooltip) {
                        tooltip.classList.add('show');
                    }
                });
                
                // é¼ æ ‡ç¦»å¼€äº‹ä»¶
                icon.addEventListener('mouseleave', function() {
                    const tooltipId = this.getAttribute('data-tooltip');
                    const tooltip = document.getElementById(tooltipId);
                    if (tooltip) {
                        tooltip.classList.remove('show');
                    }
                });
                
                // ç‚¹å‡»äº‹ä»¶ï¼ˆç”¨äºè§¦æ‘¸è®¾å¤‡ï¼‰
                icon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const tooltipId = this.getAttribute('data-tooltip');
                    const tooltip = document.getElementById(tooltipId);
                    if (tooltip) {
                        tooltip.classList.toggle('show');
                    }
                });
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹éšè—æ‰€æœ‰æç¤º
            document.addEventListener('click', function() {
                const tooltips = document.querySelectorAll('.info-tooltip');
                tooltips.forEach(tooltip => {
                    tooltip.classList.remove('show');
                });
            });
        }
        
        // åˆ‡æ¢ç³»ç»Ÿä¿¡æ¯æ˜¾ç¤º
        function toggleSystemInfo() {
            const systemInfo = document.getElementById('systemInfo');
            const toggleBtn = document.querySelector('.toggle-system-btn');
            
            systemInfoVisible = !systemInfoVisible;
            
            if (systemInfoVisible) {
                systemInfo.classList.remove('hidden');
                toggleBtn.textContent = 'éšè—ç³»ç»Ÿä¿¡æ¯';
            } else {
                systemInfo.classList.add('hidden');
                toggleBtn.textContent = 'æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯';
            }
        }
        
        // åŠ è½½æ‰€æœ‰æ•°æ®
        function loadAllData() {
            loadSystemStats();
            loadTaskStats();
            loadTasks();
            loadFailedTasks();
        }
        
        // åŠ è½½ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯
        function loadSystemStats() {
            fetch(`${API_BASE}/monitor/stats`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('cpuUsage').textContent = data.cpuUsage.toFixed(1) + '%';
                    document.getElementById('memoryUsage').textContent = (data.memoryUsed / 1024 / 1024).toFixed(0) + ' MB';
                    document.getElementById('goroutines').textContent = data.goroutines;
                    document.getElementById('workersActive').textContent = data.activeWorkers + '/' + data.workerCount;
                })
                .catch(error => {
                    console.error('è·å–ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
                });
        }
        
        // åŠ è½½ä»»åŠ¡ç»Ÿè®¡ä¿¡æ¯
        function loadTaskStats() {
            fetch(`${API_BASE}/monitor/tasks/stats`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalTasks').textContent = data.totalTasks;
                    document.getElementById('pendingTasks').textContent = data.pendingTasks;
                    document.getElementById('processingTasks').textContent = data.processingTasks;
                    document.getElementById('completedTasks').textContent = data.completedTasks;
                    document.getElementById('failedTasks').textContent = data.failedTasks;
                })
                .catch(error => {
                    console.error('è·å–ä»»åŠ¡ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
                });
        }
        
        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        function loadTasks() {
            fetch(`${API_BASE}/monitor/tasks`)
                .then(response => response.json())
                .then(data => {
                    const taskList = document.getElementById('taskList');
                    taskList.innerHTML = '';
                    
                    // åªæ˜¾ç¤ºéå¤±è´¥çŠ¶æ€çš„ä»»åŠ¡
                    const nonFailedTasks = data.filter(task => task.status !== 'failed');
                    
                    nonFailedTasks.forEach(task => {
                        const row = document.createElement('tr');
                        
                        // æ ¼å¼åŒ–çŠ¶æ€æ˜¾ç¤º
                        let statusClass = '';
                        switch(task.status) {
                            case 'pending':
                                statusClass = 'status-pending';
                                break;
                            case 'processing':
                                statusClass = 'status-processing';
                                break;
                            case 'completed':
                                statusClass = 'status-completed';
                                break;
                            case 'failed':
                                statusClass = 'status-failed';
                                break;
                        }
                        
                        // æ ¼å¼åŒ–ä¼˜å…ˆçº§æ˜¾ç¤º
                        let priorityText = '';
                        switch(task.priority) {
                            case 0:
                                priorityText = 'ä½';
                                break;
                            case 1:
                                priorityText = 'æ™®é€š';
                                break;
                            case 2:
                                priorityText = 'é«˜';
                                break;
                            case 3:
                                priorityText = 'ç´§æ€¥';
                                break;
                            default:
                                priorityText = 'æœªçŸ¥';
                        }
                        
                        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
                        const createdTime = new Date(task.created).toLocaleString();
                        const lastExecutionTime = task.lastExecution ? new Date(task.lastExecution).toLocaleString() : 'N/A';
                        
                        row.innerHTML = `
                            <td>${task.id}</td>
                            <td class="${statusClass}">${task.status}</td>
                            <td>${priorityText}</td>
                            <td>${createdTime}</td>
                            <td>${task.executionCount || 1}</td>
                            <td>${lastExecutionTime}</td>
                            <td>
                                <div class="button-group">
                                    <button class="btn btn-view" onclick="viewExecutions('${task.id}')">æŸ¥çœ‹</button>
                                    ${task.status === 'failed' ? 
                                        `<button class="btn btn-retry" onclick="retryTask('${task.id}')">é‡è¯•</button>` : 
                                        ''
                                    }
                                    ${(task.status === 'failed' || task.status === 'completed') ? 
                                        `<button class="btn btn-discard" onclick="discardTask('${task.id}')">ä¸¢å¼ƒ</button>` : 
                                        ''
                                    }
                                </div>
                            </td>
                        `;
                        
                        taskList.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
                });
        }
        
        // åŠ è½½å¤±è´¥ä»»åŠ¡åˆ—è¡¨
        function loadFailedTasks() {
            fetch(`${API_BASE}/monitor/tasks`)
                .then(response => response.json())
                .then(data => {
                    const failedTaskList = document.getElementById('failedTaskList');
                    failedTaskList.innerHTML = '';
                    
                    // åªæ˜¾ç¤ºå¤±è´¥çŠ¶æ€çš„ä»»åŠ¡
                    const failedTasks = data.filter(task => task.status === 'failed');
                    
                    failedTasks.forEach(task => {
                        const row = document.createElement('tr');
                        
                        // æ ¼å¼åŒ–ä¼˜å…ˆçº§æ˜¾ç¤º
                        let priorityText = '';
                        switch(task.priority) {
                            case 0:
                                priorityText = 'ä½';
                                break;
                            case 1:
                                priorityText = 'æ™®é€š';
                                break;
                            case 2:
                                priorityText = 'é«˜';
                                break;
                            case 3:
                                priorityText = 'ç´§æ€¥';
                                break;
                            default:
                                priorityText = 'æœªçŸ¥';
                        }
                        
                        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
                        const createdTime = new Date(task.created).toLocaleString();
                        const lastExecutionTime = task.lastExecution ? new Date(task.lastExecution).toLocaleString() : 'N/A';
                        
                        row.innerHTML = `
                            <td>${task.id}</td>
                            <td>${priorityText}</td>
                            <td>${createdTime}</td>
                            <td>${task.executionCount || 1}</td>
                            <td>${lastExecutionTime}</td>
                            <td>${task.error || 'N/A'}</td>
                            <td>
                                <div class="button-group">
                                    <button class="btn btn-view" onclick="viewExecutions('${task.id}')">æŸ¥çœ‹</button>
                                    <button class="btn btn-retry" onclick="retryTask('${task.id}')">é‡è¯•</button>
                                    <button class="btn btn-discard" onclick="discardTask('${task.id}')">ä¸¢å¼ƒ</button>
                                </div>
                            </td>
                        `;
                        
                        failedTaskList.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('è·å–å¤±è´¥ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
                });
        }
        
        // æœç´¢ä»»åŠ¡
        function searchTasks() {
            const keyword = document.getElementById('searchKeyword').value;
            const status = document.getElementById('searchStatus').value;
            
            fetch(`${API_BASE}/monitor/tasks`)
                .then(response => response.json())
                .then(data => {
                    const taskList = document.getElementById('taskList');
                    taskList.innerHTML = '';
                    
                    // æ ¹æ®æœç´¢æ¡ä»¶è¿‡æ»¤ä»»åŠ¡
                    let filteredTasks = data.filter(task => task.status !== 'failed');
                    
                    if (keyword) {
                        filteredTasks = filteredTasks.filter(task => 
                            task.id.includes(keyword)
                        );
                    }
                    
                    if (status) {
                        filteredTasks = filteredTasks.filter(task => task.status === status);
                    }
                    
                    filteredTasks.forEach(task => {
                        const row = document.createElement('tr');
                        
                        // æ ¼å¼åŒ–çŠ¶æ€æ˜¾ç¤º
                        let statusClass = '';
                        switch(task.status) {
                            case 'pending':
                                statusClass = 'status-pending';
                                break;
                            case 'processing':
                                statusClass = 'status-processing';
                                break;
                            case 'completed':
                                statusClass = 'status-completed';
                                break;
                            case 'failed':
                                statusClass = 'status-failed';
                                break;
                        }
                        
                        // æ ¼å¼åŒ–ä¼˜å…ˆçº§æ˜¾ç¤º
                        let priorityText = '';
                        switch(task.priority) {
                            case 0:
                                priorityText = 'ä½';
                                break;
                            case 1:
                                priorityText = 'æ™®é€š';
                                break;
                            case 2:
                                priorityText = 'é«˜';
                                break;
                            case 3:
                                priorityText = 'ç´§æ€¥';
                                break;
                            default:
                                priorityText = 'æœªçŸ¥';
                        }
                        
                        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
                        const createdTime = new Date(task.created).toLocaleString();
                        const lastExecutionTime = task.lastExecution ? new Date(task.lastExecution).toLocaleString() : 'N/A';
                        
                        row.innerHTML = `
                            <td>${task.id}</td>
                            <td class="${statusClass}">${task.status}</td>
                            <td>${priorityText}</td>
                            <td>${createdTime}</td>
                            <td>${task.executionCount || 1}</td>
                            <td>${lastExecutionTime}</td>
                            <td>
                                <button class="btn btn-view" onclick="viewExecutions('${task.id}')">æŸ¥çœ‹</button>
                                ${task.status === 'failed' ? 
                                    `<button class="btn btn-retry" onclick="retryTask('${task.id}')">é‡è¯•</button>` : 
                                    ''
                                }
                                ${(task.status === 'failed' || task.status === 'completed') ? 
                                    `<button class="btn btn-discard" onclick="discardTask('${task.id}')">ä¸¢å¼ƒ</button>` : 
                                    ''
                                }
                            </td>
                        `;
                        
                        taskList.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('æœç´¢ä»»åŠ¡å¤±è´¥:', error);
                });
        }
        
        // é‡è¯•ä»»åŠ¡
        function retryTask(taskId) {
            if (confirm(`ç¡®å®šè¦é‡è¯•ä»»åŠ¡ ${taskId} å—ï¼Ÿ`)) {
                fetch(`${API_BASE}/monitor/tasks/retry`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ taskId: taskId })
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    loadAllData(); // åˆ·æ–°æ•°æ®
                })
                .catch(error => {
                    console.error('é‡è¯•ä»»åŠ¡å¤±è´¥:', error);
                    alert('é‡è¯•ä»»åŠ¡å¤±è´¥: ' + error.message);
                });
            }
        }
        
        // ä¸¢å¼ƒä»»åŠ¡
        function discardTask(taskId) {
            if (confirm(`ç¡®å®šè¦ä¸¢å¼ƒä»»åŠ¡ ${taskId} å—ï¼Ÿ`)) {
                fetch(`${API_BASE}/monitor/tasks/discard`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ taskId: taskId })
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    loadAllData(); // åˆ·æ–°æ•°æ®
                })
                .catch(error => {
                    console.error('ä¸¢å¼ƒä»»åŠ¡å¤±è´¥:', error);
                    alert('ä¸¢å¼ƒä»»åŠ¡å¤±è´¥: ' + error.message);
                });
            }
        }
        
        // æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œå†å²
        function viewExecutions(taskId) {
            fetch(`${API_BASE}/monitor/tasks/${taskId}/executions`)
                .then(response => response.json())
                .then(data => {
                    const executionList = document.getElementById('executionList');
                    executionList.innerHTML = '';
                    
                    data.forEach(execution => {
                        const row = document.createElement('tr');
                        
                        // æ ¼å¼åŒ–çŠ¶æ€æ˜¾ç¤º
                        let statusClass = '';
                        switch(execution.status) {
                            case 'pending':
                                statusClass = 'status-pending';
                                break;
                            case 'processing':
                                statusClass = 'status-processing';
                                break;
                            case 'completed':
                                statusClass = 'status-completed';
                                break;
                            case 'failed':
                                statusClass = 'status-failed';
                                break;
                        }
                        
                        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
                        const startTime = execution.started ? new Date(execution.started).toLocaleString() : 'N/A';
                        const finishTime = execution.finished ? new Date(execution.finished).toLocaleString() : 'N/A';
                        
                        row.innerHTML = `
                            <td>${execution.executionNumber}</td>
                            <td class="${statusClass}">${execution.status}</td>
                            <td>${startTime}</td>
                            <td>${finishTime}</td>
                            <td>${execution.error || 'N/A'}</td>
                        `;
                        
                        executionList.appendChild(row);
                    });
                    
                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    document.getElementById('executionModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('è·å–ä»»åŠ¡æ‰§è¡Œå†å²å¤±è´¥:', error);
                    alert('è·å–ä»»åŠ¡æ‰§è¡Œå†å²å¤±è´¥: ' + error.message);
                });
        }
        
        // å…³é—­ä»»åŠ¡æ‰§è¡Œå†å²æ¨¡æ€æ¡†
        function closeExecutionModal() {
            document.getElementById('executionModal').style.display = 'none';
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('executionModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
        
        // åˆ‡æ¢ä¿¡æ¯æç¤ºæ˜¾ç¤º
        function toggleInfo(event, infoId) {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            const infoTooltip = document.getElementById(infoId);
            infoTooltip.classList.toggle('show');
            
            // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœ
            const infoIcon = event.target;
            infoIcon.addEventListener('mouseenter', () => {
                infoTooltip.classList.add('show');
            });
            infoIcon.addEventListener('mouseleave', () => {
                infoTooltip.classList.remove('show');
            });
        }
    </script>
</body>
</html>