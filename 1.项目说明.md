# ffmpeg-go

ffmpeg-go is golang port of https://github.com/kkroening/ffmpeg-python

check examples/example_test.go and ffmpeg_test.go for more examples.

# How to get and use
You can get this package via:
```
go get -u github.com/u2takey/ffmpeg-go
```

> **Note**: `ffmpeg-go` makes no attempt to download/install FFmpeg, as `ffmpeg-go` is merely a pure-Go wrapper - whereas FFmpeg installation is platform-dependent/environment-specific, and is thus the responsibility of the user, as described below.

### Installing FFmpeg

Before using `ffmpeg-go`, FFmpeg must be installed and accessible via the `$PATH` environment variable.

There are a variety of ways to install FFmpeg, such as the [official download links](https://ffmpeg.org/download.html), or using your package manager of choice (e.g. `sudo apt install ffmpeg` on Debian/Ubuntu, `brew install ffmpeg` on OS X, etc.).

Regardless of how FFmpeg is installed, you can check if your environment path is set correctly by running the `ffmpeg` command from the terminal, in which case the version information should appear, as in the following example (truncated for brevity):

```
$ ffmpeg
ffmpeg version 4.2.4-1ubuntu0.1 Copyright (c) 2000-2020 the FFmpeg developers
  built with gcc 9 (Ubuntu 9.3.0-10ubuntu2)
```

> **Note**: The actual version information displayed here may vary from one system to another; but if a message such as `ffmpeg: command not found` appears instead of the version information, FFmpeg is not properly installed.

# New Feature: Editly-like Video Editor

We've added a new high-level API inspired by [editly](https://github.com/mifi/editly) that makes it easy to create videos programmatically:

```go
spec := &ffmpeg.EditSpec{
    OutPath: "./output.mp4",
    Width:   640,
    Height:  480,
    Fps:     25,
    Clips: []*ffmpeg.Clip{
        {
            Layers: []*ffmpeg.Layer{
                {
                    Type: "video",
                    Path: "./input.mp4",
                },
            },
        },
        {
            Layers: []*ffmpeg.Layer{
                {
                    Type: "title",
                    Text: "Hello World",
                    Color: "blue",
                },
            },
        },
    },
    Verbose: true,
}

err := ffmpeg.Edit(spec)
```

Or load from a JSON file:

```go
editly, err := ffmpeg.FromFile("./editly_spec.json")
if err != nil {
    log.Fatal(err)
}
err = editly.Edit()
```

You can run the editly examples with:
```bash
go test -v ./examples -run TestExampleEditly
```

# Project Documentation

- [Development Plan](development_plan.md) - Complete development plan for extending this library into a full-fledged video editing service
- [Requirements Specification](requirements.md) - Detailed requirements specification for the video editing service

# Examples

```go
split := Input(TestInputFile1).VFlip().Split()
	split0, split1 := split.Get("0"), split.Get("1")
	overlayFile := Input(TestOverlayFile).Crop(10, 10, 158, 112)
err := Concat([]*Stream{
    split0.Trim(KwArgs{"start_frame": 10, "end_frame": 20}),
    split1.Trim(KwArgs{"start_frame": 30, "end_frame": 40})}).
    Overlay(overlayFile.HFlip(), "").
    DrawBox(50, 50, 120, 120, "red", 5).
    Output(TestOutputFile1).
    OverWriteOutput().
    Run()
```

## Transcoding From One Codec To Another

```go
err := ffmpeg.Input("./sample_data/in1.mp4").
		Output("./sample_data/out1.mp4", ffmpeg.KwArgs{"c:v": "libx265"}).
		OverWriteOutput().ErrorToStdOut().Run()
```

## Cut Video From Timestamp

```go
err := ffmpeg.Input("./sample_data/in1.mp4", ffmpeg.KwArgs{"ss": 1}).
    Output("./sample_data/out1.mp4", ffmpeg.KwArgs{"t": 1}).OverWriteOutput().Run()
assert.Nil(t, err)
```

## Add Watermark For Video
```go
// show watermark with size 64:-1 in the top left corner after seconds 1
overlay := ffmpeg.Input("./sample_data/overlay.png").Filter("scale", ffmpeg.Args{"64:-1"})
err := ffmpeg.Filter(
    []*ffmpeg.Stream{
        ffmpeg.Input("./sample_data/in1.mp4"),
        overlay,
    }, "overlay", ffmpeg.Args{"10:10"}, ffmpeg.KwArgs{"enable": "gte(t,1)"}).
    Output("./sample_data/out1.mp4").OverWriteOutput().ErrorToStdOut().Run()
```

result:

![img.png](./docs/example_overlay.png)

## Cut Video For Gif 

```go
err := ffmpeg.Input("./sample_data/in1.mp4", ffmpeg.KwArgs{"ss": "1"}).
    Output("./sample_data/out1.gif", ffmpeg.KwArgs{"s": "320x240", "pix_fmt": "rgb24", "t": "3", "r": "3"}).
    OverWriteOutput().ErrorToStdOut().Run()
```

result:

![img.png](./docs/example_gif.gif)

## Task Frame From Video

```bash
func ExampleReadFrameAsJpeg(inFileName string, frameNum int) io.Reader {
	buf := bytes.NewBuffer(nil)
	err := ffmpeg.Input(inFileName).
		Filter("select", ffmpeg.Args{fmt.Sprintf("gte(n,%d)", frameNum)}).
		Output("pipe:", ffmpeg.KwArgs{"vframes": 1, "format": "image2", "vcodec": "mjpeg"}).
		WithOutput(buf, os.Stdout).
		Run()
	if err != nil {
		panic(err)
	}
	return buf
}

reader := ExampleReadFrameAsJpeg("./sample_data/in1.mp4", 5)
img, err := imaging.Decode(reader)
if err != nil {
    t.Fatal(err)
}
err = imaging.Save(img, "./sample_data/out1.jpeg")
if err != nil {
    t.Fatal(err)
}
```
result : 

![image](./examples/sample_data/out1.jpeg)

## Get Multiple Output

```go
// get multiple output with different size/bitrate
input := ffmpeg.Input("./sample_data/in1.mp4").Split()
out1 := input.Get("0").Filter("scale", ffmpeg.Args{"1920:-1"}).
Output("./sample_data/1920.mp4", ffmpeg.KwArgs{"b:v": "5000k"})
out2 := input.Get("1").Filter("scale", ffmpeg.Args{"1280:-1"}).
Output("./sample_data/1280.mp4", ffmpeg.KwArgs{"b:v": "2800k"})

err := ffmpeg.MergeOutputs(out1, out2).OverWriteOutput().ErrorToStdOut().Run()
```

## Show FFmpeg Progress

see complete example at: [showProgress](./examples/showProgress.go)

```bash
func ExampleShowProgress(inFileName, outFileName string) {
	a, err := ffmpeg.Probe(inFileName)
	if err != nil {
		panic(err)
	}
	totalDuration := gjson.Get(a, "format.duration").Float()

	err = ffmpeg.Input(inFileName).
		Output(outFileName, ffmpeg.KwArgs{"c:v": "libx264", "preset": "veryslow"}).
		GlobalArgs("-progress", "unix://"+TempSock(totalDuration)).
		OverWriteOutput().
		Run()
	if err != nil {
		panic(err)
	}
}
ExampleShowProgress("./sample_data/in1.mp4", "./sample_data/out2.mp4")
```

result 

```bash
progress:  .0
progress:  0.72
progress:  1.00
progress:  done
```

## Integrate FFmpeg-go With Open-CV (gocv) For Face-detect

see complete example at: [opencv](./examples/opencv_test.go)

result: ![image](./examples/sample_data/face-detect.jpg)

## Set Cpu limit/request For FFmpeg-go

```go
e := ComplexFilterExample("./sample_data/in1.mp4", "./sample_data/overlay.png", "./sample_data/out2.mp4")
err := e.RunWithResource(0.1, 0.5)
if err != nil {
    assert.Nil(t, err)
}
```

result from command top: we will see ffmpeg used 0.5 core as expected.

```bash
> top 
PID    USER       PR  NI    VIRT    RES    SHR S  %CPU   %MEM     TIME+ COMMAND
1386105 root      20   0 2114152 273780  31672 R  50.2   1.7      0:16.79 ffmpeg
```

# View Progress Graph

function view generate [mermaid](https://mermaid-js.github.io/mermaid/#/) chart, which can be use in markdown or view [online](https://mermaid-js.github.io/mermaid-live-editor/)

```go
split := Input(TestInputFile1).VFlip().Split()
	split0, split1 := split.Get("0"), split.Get("1")
	overlayFile := Input(TestOverlayFile).Crop(10, 10, 158, 112)
b, err := Concat([]*Stream{
    split0.Trim(KwArgs{"start_frame": 10, "end_frame": 20}),
    split1.Trim(KwArgs{"start_frame": 30, "end_frame": 40})}).
    Overlay(overlayFile.HFlip(), "").
    DrawBox(50, 50, 120, 120, "red", 5).
    Output(TestOutputFile1).
    OverWriteOutput().View(ViewTypeFlowChart)
fmt.Println(b)
```
![image](./docs/flowchart2.png)

# ffmpeg-go è§†é¢‘ç¼–è¾‘æœåŠ¡

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯åŸºäº [ffmpeg-go](https://github.com/u2takey/ffmpeg-go) åº“æ„å»ºçš„è§†é¢‘ç¼–è¾‘æœåŠ¡ï¼Œæä¾› HTTP API æ¥å£ï¼Œæ”¯æŒé«˜å¹¶å‘å¤„ç†ï¼Œå…·å¤‡ä¸°å¯Œçš„è§†é¢‘ç¼–è¾‘åŠŸèƒ½ï¼Œå¹¶èƒ½ä¸äº‘å­˜å‚¨ç³»ç»Ÿé›†æˆã€‚

## åŠŸèƒ½ç‰¹æ€§

1. **HTTP API æ¥å£**ï¼šæä¾› RESTful API æ¥å£ï¼Œä¾¿äºé›†æˆåˆ°å„ç§åº”ç”¨ä¸­
2. **é«˜å¹¶å‘æ”¯æŒ**ï¼šæ”¯æŒé«˜å¹¶å‘ä»»åŠ¡å¤„ç†ï¼Œé€šè¿‡å·¥ä½œæ± æ¨¡å¼æ§åˆ¶èµ„æºä½¿ç”¨
3. **è§†é¢‘ç¼–è¾‘åŠŸèƒ½**ï¼šæ”¯æŒå¤šç§è§†é¢‘ç¼–è¾‘æ“ä½œï¼ŒåŒ…æ‹¬å‰ªè¾‘ã€åˆå¹¶ã€è½¬åœºæ•ˆæœç­‰
4. **JSON å£°æ˜å¼æ¥å£**ï¼šé€šè¿‡ JSON é…ç½®æ–‡ä»¶å®šä¹‰è§†é¢‘ç¼–è¾‘ä»»åŠ¡
5. **äº‘å­˜å‚¨æ”¯æŒ**ï¼šæ”¯æŒä¸é˜¿é‡Œäº‘ OSS ç­‰äº‘å­˜å‚¨æœåŠ¡é›†æˆ
6. **èµ„æºç®¡ç†**ï¼šæ™ºèƒ½ç®¡ç† CPU å’Œå†…å­˜èµ„æºï¼Œé¿å…ç³»ç»Ÿè¿‡è½½

## å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
go mod tidy
```

### è¿è¡ŒæœåŠ¡

```bash
cd cmd
go run main.go
```

æœåŠ¡é»˜è®¤è¿è¡Œåœ¨ `8082` ç«¯å£ã€‚

### APIæ–‡æ¡£

æœåŠ¡å¯åŠ¨åï¼Œå¯ä»¥é€šè¿‡è®¿é—® `http://localhost:8082/swagger/index.html` æŸ¥çœ‹APIæ–‡æ¡£å’Œè¿›è¡Œæ¥å£æµ‹è¯•ã€‚

## API æ¥å£

### 1. æäº¤è§†é¢‘ç¼–è¾‘ä»»åŠ¡

```
POST /api/v1/video/edit
```

è¯·æ±‚ä½“æ ¼å¼ï¼š
```json
{
  "spec": {
    // è§†é¢‘ç¼–è¾‘è§„èŒƒ
  },
  "outputPath": "/path/to/output.mp4",
  "ossOutput": {
    "bucket": "my-bucket",
    "key": "output.mp4",
    "endpoint": "oss-cn-hangzhou.aliyuncs.com",
    "accessKey": "your-access-key",
    "secretKey": "your-secret-key"
  }
}
```

### 2. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

```
GET /api/v1/video/edit/{taskId}
```

### 3. å–æ¶ˆä»»åŠ¡

```
DELETE /api/v1/video/edit/{taskId}
```

## æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚â”€â”€â”€â–¶â”‚  HTTP Server â”‚â”€â”€â”€â–¶â”‚ Task Queue   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   Worker Pool       â”‚
                              â”‚                     â”‚
                              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                              â”‚  â”‚    Worker 1    â”‚ â”‚
                              â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
                              â”‚  â”‚    Worker 2    â”‚ â”‚
                              â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
                              â”‚  â”‚    Worker N    â”‚ â”‚
                              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é‡Œç¨‹ç¢‘å®Œæˆæƒ…å†µ

### é‡Œç¨‹ç¢‘1ï¼šWebæ¥å£å¼€å‘å®Œæˆ âœ… (å·²å®Œæˆ)

ç›®æ ‡ï¼šå®ŒæˆWebæ¥å£å¼€å‘ï¼Œèƒ½å¤Ÿæ­£ç¡®å¤„ç†è¯·æ±‚å’Œå“åº”

å®Œæˆå†…å®¹ï¼š
1. å®ç°äº†å®Œæ•´çš„APIç«¯ç‚¹ï¼ˆä»»åŠ¡æäº¤ã€çŠ¶æ€æŸ¥è¯¢ã€ä»»åŠ¡å–æ¶ˆï¼‰
2. å®ç°äº†è¯·æ±‚å’Œå“åº”çš„æ•°æ®ç»“æ„
3. é›†æˆäº†Gin Webæ¡†æ¶
4. æ·»åŠ äº†Swagger APIæ–‡æ¡£æ”¯æŒ

### é‡Œç¨‹ç¢‘2ï¼šåŸºäºffmpeg-goçš„è§†é¢‘æœåŠ¡éªŒè¯ â³ (è¿›è¡Œä¸­)

ç›®æ ‡ï¼šç¡®è®¤å®Œå…¨ç»§æ‰¿äº†åŸæœ‰é¡¹ç›®çš„åŠŸèƒ½ï¼Œå¯ä»¥æ­£ç¡®åœ°æ ¹æ®æŒ‡ä»¤è¿›è¡Œè§†é¢‘åˆæˆ

### é‡Œç¨‹ç¢‘3ï¼šWebæ¥å£ä¸ffmpeg-goçš„å¯¹æ¥ ğŸ”œ (å¾…å®Œæˆ)

ç›®æ ‡ï¼šæ”¯æŒé€šè¿‡POSTè¯·æ±‚è°ƒç”¨è§†é¢‘æœåŠ¡

## æŠ€æœ¯æ ˆ

- Go 1.16+
- Gin Web æ¡†æ¶
- ffmpeg-go åº“
- Swagger API æ–‡æ¡£

## è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäº MIT è®¸å¯è¯å¼€æºã€‚
