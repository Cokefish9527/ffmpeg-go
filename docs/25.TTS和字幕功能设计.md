# TTS和字幕功能设计文档

## 1. 概述

本文档详细描述了如何在现有视频处理服务中集成文字转语音(TTS)和文字转字幕功能。设计遵循模块化和可替换原则，以便在未来可以轻松替换或升级TTS引擎和字幕处理方案。

## 2. 功能需求

### 2.1 文字转语音(TTS)功能
- 将用户提供的文本转换为音频文件
- 支持多种语音参数配置（语速、音调等）
- 生成的音频文件可作为音轨参与视频合成

### 2.2 文字转字幕功能
- 将用户提供的文本转换为字幕文件
- 支持多种字幕格式（SRT、ASS等）
- 生成的字幕文件可叠加到视频中

## 3. 架构设计

### 3.1 模块化设计原则
1. 使用接口抽象TTS和字幕生成功能
2. 实现基于开源方案的具体实现
3. 支持通过配置切换不同的实现方案
4. 保持与现有视频处理流程的松耦合

### 3.2 核心组件

#### 3.2.1 TTS服务接口
```go
type TTSService interface {
    // 将文本转换为音频文件
    GenerateAudio(text string, options TTSOptions) (string, error)
    // 获取服务名称
    Name() string
}
```

#### 3.2.2 字幕服务接口
```go
type SubtitleService interface {
    // 将文本转换为字幕文件
    GenerateSubtitle(text string, options SubtitleOptions) (string, error)
    // 获取服务名称
    Name() string)
}
```

#### 3.2.3 服务工厂
```go
type ServiceFactory interface {
    // 创建TTS服务
    CreateTTSService(config map[string]interface{}) (TTSService, error)
    // 创建字幕服务
    CreateSubtitleService(config map[string]interface{}) (SubtitleService, error)
}
```

### 3.3 配置管理
通过配置文件管理不同服务的实现和参数：
```yaml
tts:
  provider: "espeak"  # 可选: espeak, flite, 或其他
  options:
    voice: "default"
    speed: 150

subtitle:
  provider: "srt"     # 可选: srt, ass
  options:
    font: "Arial"
    size: 16
```

## 4. 开源方案选型

### 4.1 TTS引擎选型

#### 4.1.1 eSpeak（推荐默认方案）
- 轻量级开源TTS引擎
- 支持多种语言
- 跨平台支持
- 可通过命令行调用

#### 4.1.2 Flite
- CMU开发的轻量级TTS系统
- 适合嵌入式系统
- 快速语音合成

### 4.2 字幕生成方案

#### 4.2.1 SRT格式生成器
- 最简单的字幕格式
- 易于生成和解析
- 被大多数播放器支持

#### 4.2.2 ASS格式生成器
- 高级字幕格式
- 支持复杂样式和动画
- 与FFmpeg集成良好

## 5. 集成方案

### 5.1 与视频编辑流程集成

#### 5.1.1 扩展视频编辑规范
在现有的[EditSpec](file:///D:/Work/hsch/ffmpeg-go/editly.go#L17-L35)结构中添加TTS和字幕相关字段：

```go
type EditSpec struct {
    // ... 现有字段 ...
    
    // TTS相关配置
    TTSConfig *TTSConfig `json:"ttsConfig,omitempty"`
    
    // 字幕相关配置
    SubtitleConfig *SubtitleConfig `json:"subtitleConfig,omitempty"`
}

type TTSConfig struct {
    Text   string            `json:"text"`
    Options map[string]interface{} `json:"options,omitempty"`
}

type SubtitleConfig struct {
    Text   string            `json:"text"`
    Options map[string]interface{} `json:"options,omitempty"`
}
```

#### 5.1.2 处理流程
1. 在视频编辑开始前，检查是否存在TTS配置
2. 如果存在，调用TTS服务生成音频文件
3. 将生成的音频文件作为额外的音轨添加到视频编辑流程中
4. 在视频编辑开始前，检查是否存在字幕配置
5. 如果存在，调用字幕服务生成字幕文件
6. 将生成的字幕文件作为额外的字幕流添加到视频编辑流程中

### 5.2 与任务队列集成
1. TTS和字幕生成作为视频编辑任务的预处理步骤
2. 在工作池中添加对TTS和字幕生成任务的支持
3. 通过任务状态跟踪TTS和字幕生成进度

## 6. API设计

### 6.1 扩展视频编辑API
在现有的视频编辑请求中添加TTS和字幕配置：

```json
{
  "spec": {
    "outPath": "./output.mp4",
    "width": 1920,
    "height": 1080,
    "fps": 30,
    "clips": [...],
    "ttsConfig": {
      "text": "这是视频的语音解说内容",
      "options": {
        "speed": 150,
        "voice": "default"
      }
    },
    "subtitleConfig": {
      "text": "这是视频的字幕内容",
      "options": {
        "format": "srt"
      }
    }
  }
}
```

## 7. 实施计划

### 7.1 第一阶段：核心接口和基础实现
- 定义TTS和字幕服务接口
- 实现eSpeak TTS服务
- 实现SRT字幕生成服务
- 创建服务工厂和配置管理模块

### 7.2 第二阶段：与视频编辑流程集成
- 扩展视频编辑规范
- 在视频编辑流程中集成TTS和字幕处理
- 实现API接口扩展

### 7.3 第三阶段：优化和完善
- 添加Flite TTS引擎支持
- 添加ASS字幕格式支持
- 实现性能优化
- 完善错误处理和日志记录

## 8. 可替换性设计

### 8.1 插件化架构
通过以下方式确保方案的可替换性：
1. 使用接口抽象核心功能
2. 通过配置文件选择具体实现
3. 遵循统一的初始化和调用方式
4. 提供标准的输入输出格式

### 8.2 升级路径
1. 添加新的TTS引擎实现只需实现TTSService接口
2. 添加新的字幕格式支持只需实现SubtitleService接口
3. 通过修改配置文件即可切换不同实现

## 9. 性能考虑

1. TTS和字幕生成作为预处理步骤，不影响视频处理核心流程
2. 生成的文件可缓存，避免重复处理相同内容
3. 支持并发处理多个TTS或字幕生成任务

## 10. 错误处理

1. TTS或字幕生成失败不应影响整个视频编辑任务
2. 提供详细的错误信息和日志记录
3. 支持重试机制

## 11. 测试策略

### 11.1 单元测试
- TTS服务接口测试
- 字幕服务接口测试
- 配置管理模块测试

### 11.2 集成测试
- 与视频编辑流程的集成测试
- 不同TTS引擎的兼容性测试
- 不同字幕格式的兼容性测试

### 11.3 性能测试
- TTS生成性能测试
- 字幕生成性能测试
- 整体流程性能影响评估

## 12. 部署和运维

1. 确保eSpeak或Flite等TTS引擎在部署环境中可用
2. 配置文件支持环境相关的参数设置
3. 提供监控指标，跟踪TTS和字幕生成成功率